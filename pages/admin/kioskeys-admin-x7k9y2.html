<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Control - Kioskeys</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* ... (estilos anteriores se mantienen igual) ... */
  </style>
</head>
<body>
  <!-- ... (HTML anterior se mantiene igual) ... -->

  <script>
    // Función para actualizar estadísticas de forma segura
    function updateStats() {
      try {
        // Obtener productos
        const products = JSON.parse(localStorage.getItem('kioskeys_products')) || [];
        const productsElement = document.getElementById('totalProducts');
        if (productsElement) {
          productsElement.textContent = products.length;
        }

        // Obtener categorías únicas
        const categories = [...new Set(products.map(p => p.category))];
        const categoriesElement = document.getElementById('totalCategories');
        if (categoriesElement) {
          categoriesElement.textContent = categories.length;
        }

        // Obtener imágenes
        const images = JSON.parse(localStorage.getItem('kioskeys_images')) || [];
        const imagesElement = document.getElementById('totalImages');
        if (imagesElement) {
          imagesElement.textContent = images.length;
        }
      } catch (error) {
        console.error('Error al actualizar estadísticas:', error);
      }
    }

    // Función para manejar navegación segura
    function handleNavigation(url) {
      try {
        window.location.href = url;
      } catch (error) {
        console.error('Error al navegar:', error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo navegar a la página solicitada',
          icon: 'error'
        });
      }
    }

    // Inicializar página de forma segura
    function initializePage() {
      try {
        // Actualizar estadísticas iniciales
        updateStats();

        // Agregar event listeners para navegación
        document.querySelectorAll('[data-href]').forEach(element => {
          element.addEventListener('click', (e) => {
            e.preventDefault();
            handleNavigation(element.dataset.href);
          });
        });

        // Configurar actualizaciones periódicas de estadísticas
        let updateInterval = null;

        function startUpdateInterval() {
          if (updateInterval) clearInterval(updateInterval);
          updateInterval = setInterval(updateStats, 30000); // Actualizar cada 30 segundos
        }

        // Iniciar actualizaciones
        startUpdateInterval();

        // Limpiar intervalo cuando la página se oculta
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            if (updateInterval) clearInterval(updateInterval);
          } else {
            startUpdateInterval();
          }
        });

        // Limpiar intervalo al descargar la página
        window.addEventListener('beforeunload', () => {
          if (updateInterval) clearInterval(updateInterval);
        });

      } catch (error) {
        console.error('Error al inicializar la página:', error);
      }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePage);
    } else {
      initializePage();
    }
  </script>
</body>
</html>