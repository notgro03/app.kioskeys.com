<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración - Kioskeys</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .admin-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .preview-container {
      margin-top: 16px;
    }
    .color-picker {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .color-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      background: var(--primary-blue);
      color: white;
    }
    .brands-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .brand-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .brand-logo {
      width: 120px;
      height: 80px;
      object-fit: contain;
      margin: 0 auto 16px;
    }
    .product-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    .tab-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    .tab-button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #f0f0f0;
    }
    .tab-button.active {
      background: var(--primary-blue);
      color: white;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">
      <a href="/"><img src="/logo.svg" alt="Kioskeys" id="navLogo" data-logo></a>
    </div>
    <div class="nav-links">
      <a href="/">Inicio</a>
      <a href="#" class="active">Panel Admin</a>
    </div>
  </nav>

  <main>
    <section class="hero">
      <div class="hero-content">
        <h1>Panel de Administración</h1>
        <p>Gestiona el contenido de tu sitio</p>
      </div>
    </section>

    <div class="admin-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="appearance">Apariencia</button>
        <button class="tab-button" data-tab="brands">Marcas</button>
        <button class="tab-button" data-tab="products">Productos</button>
      </div>

      <!-- Apariencia -->
      <section class="admin-section" id="appearance-section" data-section="appearance">
        <h2>Personalización</h2>
        
        <div class="form-group">
          <label>Logo del Sitio</label>
          <input type="hidden" role="uploadcare-uploader" id="logoUploader" data-images-only="true">
          <div id="logoPreview" class="preview-container">
            <img src="/logo.svg" alt="Logo actual" data-logo style="max-width: 200px;">
          </div>
        </div>

        <div class="form-group">
          <label>Color Principal</label>
          <div class="color-picker">
            <input type="color" id="primaryColor" value="#003B8E">
            <div class="color-preview" id="primaryPreview"></div>
          </div>
        </div>

        <div class="form-group">
          <label>Color Secundario</label>
          <div class="color-picker">
            <input type="color" id="secondaryColor" value="#00A3FF">
            <div class="color-preview" id="secondaryPreview"></div>
          </div>
        </div>

        <button onclick="saveAppearance()" class="btn btn-primary">
          Guardar Cambios
        </button>
      </section>

      <!-- Marcas -->
      <section class="admin-section" id="brands-section" data-section="brands" style="display: none;">
        <h2>Gestión de Marcas</h2>
        <div class="brands-grid" id="brandsGrid"></div>
      </section>

      <!-- Productos -->
      <section class="admin-section" id="products-section" data-section="products" style="display: none;">
        <h2>Gestión de Productos</h2>
        
        <form id="productForm" class="product-form">
          <div class="form-group">
            <label>Categoría</label>
            <select id="productCategory" required>
              <option value="">Seleccionar categoría</option>
              <option value="telemandos">Telemandos</option>
              <option value="llaves">Llaves</option>
              <option value="carcasas">Carcasas</option>
            </select>
          </div>

          <div class="form-group">
            <label>Marca</label>
            <select id="productBrand" required>
              <option value="">Seleccionar marca</option>
            </select>
          </div>

          <div class="form-group">
            <label>Modelo</label>
            <select id="productModel" required disabled>
              <option value="">Seleccionar modelo</option>
            </select>
          </div>

          <div class="form-group">
            <label>Año</label>
            <select id="productYear" required disabled>
              <option value="">Seleccionar año</option>
            </select>
          </div>

          <div class="form-group">
            <label>Imagen del Producto</label>
            <input type="hidden" role="uploadcare-uploader" id="productImage" data-images-only="true">
            <div id="productImagePreview" class="preview-container"></div>
          </div>

          <div class="form-group">
            <label>Precio</label>
            <input type="number" id="productPrice" required min="0" step="0.01">
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary">Guardar Producto</button>
          </div>
        </form>

        <div id="productsList"></div>
      </section>
    </div>
  </main>

  <script type="module">
    import { UPLOADCARE_CONFIG } from './js/config.js';
    import { initializeUploader, saveLogo, loadLogo } from './js/upload.js';
    import { updateTheme, getTheme, applyTheme } from './js/theme.js';
    import { addProduct, updateProduct, deleteProduct, getAllProducts } from './js/products.js';
    import { updateBrandLogo, getAllBrands, getBrandModels, getModelYears } from './js/brands.js';

    // Initialize Uploadcare
    window.UPLOADCARE_PUBLIC_KEY = UPLOADCARE_CONFIG.publicKey;

    // Tab Navigation
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // Update active button
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Show corresponding section
        const tabName = button.dataset.tab;
        document.querySelectorAll('[data-section]').forEach(section => {
          section.style.display = section.dataset.section === tabName ? 'block' : 'none';
        });
      });
    });

    // Initialize Brand Management
    function initializeBrands() {
      const brandsGrid = document.getElementById('brandsGrid');
      const brands = getAllBrands();

      brandsGrid.innerHTML = '';
      Object.entries(brands).forEach(([brand, data]) => {
        const card = document.createElement('div');
        card.className = 'brand-card';
        card.innerHTML = `
          <img src="${data.logo}" alt="${brand}" class="brand-logo">
          <h3>${brand}</h3>
          <input type="hidden" role="uploadcare-uploader" id="brandLogo_${brand}">
        `;
        brandsGrid.appendChild(card);

        // Initialize uploader for this brand
        initializeUploader(`#brandLogo_${brand}`, {
          onSuccess: (fileInfo) => {
            updateBrandLogo(brand, fileInfo.cdnUrl);
            card.querySelector('.brand-logo').src = fileInfo.cdnUrl;
            Swal.fire({
              title: 'Logo actualizado',
              icon: 'success',
              timer: 2000
            });
          }
        });
      });
    }

    // Initialize Product Management
    function initializeProducts() {
      const brandSelect = document.getElementById('productBrand');
      const modelSelect = document.getElementById('productModel');
      const yearSelect = document.getElementById('productYear');
      const brands = getAllBrands();

      // Populate brands dropdown
      brandSelect.innerHTML = '<option value="">Seleccionar marca</option>';
      Object.keys(brands).forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });

      // Handle brand selection
      brandSelect.addEventListener('change', () => {
        const brand = brandSelect.value;
        const models = getBrandModels(brand);

        modelSelect.innerHTML = '<option value="">Seleccionar modelo</option>';
        modelSelect.disabled = !brand;
        yearSelect.innerHTML = '<option value="">Seleccionar año</option>';
        yearSelect.disabled = true;

        if (brand) {
          Object.keys(models).forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
          });
        }
      });

      // Handle model selection
      modelSelect.addEventListener('change', () => {
        const brand = brandSelect.value;
        const model = modelSelect.value;
        const years = getModelYears(brand, model);

        yearSelect.innerHTML = '<option value="">Seleccionar año</option>';
        yearSelect.disabled = !model;

        if (model) {
          years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          });
        }
      });

      // Initialize product image uploader
      initializeUploader('#productImage', {
        onSuccess: (fileInfo) => {
          createImagePreview(fileInfo.cdnUrl, document.getElementById('productImagePreview'));
        }
      });

      // Handle form submission
      document.getElementById('productForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const productData = {
          category: document.getElementById('productCategory').value,
          brand: brandSelect.value,
          model: modelSelect.value,
          year: yearSelect.value,
          image: document.querySelector('#productImagePreview img')?.src,
          price: parseFloat(document.getElementById('productPrice').value)
        };

        if (addProduct(productData)) {
          Swal.fire({
            title: 'Producto agregado',
            icon: 'success',
            timer: 2000
          });
          e.target.reset();
          document.getElementById('productImagePreview').innerHTML = '';
        }
      });
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Load saved logo
      const savedLogo = loadLogo();
      if (savedLogo) {
        document.querySelectorAll('[data-logo]').forEach(img => {
          img.src = savedLogo;
        });
      }

      // Initialize logo uploader
      initializeUploader('#logoUploader', {
        crop: '1:1',
        onSuccess: (fileInfo) => {
          saveLogo(fileInfo.cdnUrl);
          document.querySelectorAll('[data-logo]').forEach(img => {
            img.src = fileInfo.cdnUrl;
          });
          Swal.fire({
            title: '¡Logo actualizado!',
            icon: 'success',
            timer: 2000
          });
        }
      });

      // Initialize theme
      const theme = getTheme();
      applyTheme(theme);
      
      document.getElementById('primaryColor').value = theme.primaryColor;
      document.getElementById('secondaryColor').value = theme.secondaryColor;
      
      function updateColorPreviews() {
        document.getElementById('primaryPreview').style.backgroundColor = document.getElementById('primaryColor').value;
        document.getElementById('secondaryPreview').style.backgroundColor = document.getElementById('secondaryColor').value;
      }
      
      document.getElementById('primaryColor').addEventListener('input', updateColorPreviews);
      document.getElementById('secondaryColor').addEventListener('input', updateColorPreviews);
      updateColorPreviews();

      // Initialize other sections
      initializeBrands();
      initializeProducts();
    });

    // Save appearance changes
    window.saveAppearance = () => {
      const themeData = {
        primaryColor: document.getElementById('primaryColor').value,
        secondaryColor: document.getElementById('secondaryColor').value
      };

      updateTheme(themeData);
      Swal.fire({
        title: '¡Cambios guardados!',
        icon: 'success',
        timer: 2000
      });
    };
  </script>
</body>
</html>